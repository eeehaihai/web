<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å¤§æ ‘æ´ - è¯é¢˜è¯¦æƒ…</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header>
        <div class="container header-content">
            <a href="home.html" class="logo">
                <h1>å‰å¤§æ ‘æ´</h1>
            </a>

            <div class="user-actions">
                <!-- æ­¤å¤„ä¼šé€šè¿‡JSåŠ¨æ€æ›´æ–°ç”¨æˆ·ç™»å½•çŠ¶æ€ -->
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-container topic-detail-container">
            <a href="javascript:history.back();" class="nav-link-top-left button-styled-back">è¿”å›</a>
            <!-- è¯é¢˜è¯¦æƒ…åŒºåŸŸ -->
            <div id="topicDetail" class="topic-detail">
                <div class="loading">æ­£åœ¨åŠ è½½è¯é¢˜å†…å®¹...</div>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨åŒºåŸŸ -->
            <div class="comment-section">
                <div class="comment-header">
                    <h2>å…¨éƒ¨è¯„è®º <span id="commentCount">0</span></h2>
                    <div class="comment-sort-options">
                        <a href="#" class="active" data-sort="floor_asc">æ­£åº</a>
                        <a href="#" data-sort="floor_desc">é™åº</a>
                        <a href="#" data-sort="hot">çƒ­é—¨</a>
                    </div>
                </div>
                <div id="commentList" class="comment-list">
                    <div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®åŠ¨å›å¤æŒ‰é’® (ç”¨äºå›å¤è¯é¢˜) -->
    <div class="floating-reply-btn" id="floatingReplyBtnMainTopic" onclick="openReplyModalForTopic()">
        <span class="reply-icon">ğŸ’¬</span>
        <span class="reply-text">å›å¤è¯é¢˜</span>
    </div>

    <!-- å›å¤è¯é¢˜çš„æ¨¡æ€æ¡† (å±…ä¸­) -->
    <div id="replyModal" class="reply-modal-overlay" style="display: none;">
        <div class="reply-modal-content" id="replyModalContent">
            <div class="reply-modal-header">
                <h3 id="replyModalTitle">å›å¤è¯é¢˜</h3>
                <span class="reply-modal-close" onclick="closeReplyModal()">&times;</span>
            </div>
            <div class="reply-modal-body">
                <form id="replyForm">
                    <!-- parentCommentId, replyToFloor, replyToAuthor ä»…ç”¨äºä¸»å›å¤æ¨¡æ€æ¡†ï¼Œå¯¹äºè¯é¢˜å›å¤ï¼Œè¿™äº›å€¼ä¸ºç©ºæˆ–0 -->
                    <input type="hidden" id="parentCommentId" name="parentCommentId" value="">
                    <input type="hidden" id="replyToFloor" name="replyToFloor" value="0">
                    <input type="hidden" id="replyToAuthor" name="replyToAuthor" value="">
                    
                    <div class="form-group">
                        <label for="reply_content" class="required">è¯„è®ºå†…å®¹</label>
                        <textarea id="reply_content" name="reply_content" required placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®ºå†…å®¹..." rows="6"></textarea>
                        <div class="tips">æ–‡æ˜å‘è¨€ï¼Œå‹å–„äº¤æµ</div>
                    </div>

                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸï¼Œä»…ç”¨äºå›å¤è¯é¢˜ -->
                    <div class="upload-section" id="modalUploadSection">
                        <label>æ·»åŠ å›¾ç‰‡</label>
                        <input type="file" id="images" name="images[]" class="file-input" accept="image/*" multiple>
                        <label for="images" class="file-label">é€‰æ‹©å›¾ç‰‡</label>
                        <span id="file-count">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <div class="tips">æœ€å¤šå¯ä¸Šä¼ 3å¼ å›¾ç‰‡ï¼Œæ¯å¼ ä¸è¶…è¿‡5MB</div>
                        <div class="files-preview" id="preview-container"></div>
                    </div>

                    <div class="form-group">
                        <div class="option-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="anonymous" name="anonymous" value="1">
                                <label for="anonymous">åŒ¿åè¯„è®º</label>
                            </div>
                        </div>
                    </div>

                    <div id="message" class="message-box" style="display: none;"></div>
                </form>
            </div>
            <div class="reply-modal-footer">
                <button type="button" class="cancel-btn" onclick="closeReplyModal()">å–æ¶ˆ</button>
                <button type="button" class="submit-btn" onclick="submitReply()">å‘è¡¨è¯„è®º</button>
            </div>
        </div>
    </div>

    <!-- å†…è”å›å¤æ¡† (ç”¨äºå›å¤è¯„è®º/æ¥¼ä¸­æ¥¼) -->
    <div id="inlineReplyBox" class="inline-reply-box" style="display: none;">
        <input type="hidden" id="inlineParentCommentId">
        <input type="hidden" id="inlineReplyToFloor">
        <input type="hidden" id="inlineReplyToAuthor">
        <input type="hidden" id="inlineReplyToAuthorId"> <!-- æ–°å¢ -->
        <input type="hidden" id="inlineReplyTargetCommentId"> <!-- æ–°å¢ -->
        <textarea id="inlineReplyContent" placeholder="æ·»åŠ å›å¤..." rows="2"></textarea>
        <div class="inline-reply-actions">
            <button type="button" class="inline-reply-submit-btn" onclick="submitInlineReply()">å›å¤</button>
            <button type="button" class="inline-reply-cancel-btn" onclick="closeInlineReplyBox()">å–æ¶ˆ</button>
        </div>
        <div id="inlineReplyMessage" class="message-box" style="display: none; font-size: 0.9em; padding: 5px; margin-top: 5px;"></div>
    </div>

    <script>
        let currentSortBy = 'floor_asc';
        let isReplyModalDragging = false;
        let replyModalOffset = { x: 0, y: 0 };
        let currentTopicCommentsData = []; // å­˜å‚¨å½“å‰è¯é¢˜çš„æ‰€æœ‰è¯„è®º
        const REPLIES_PER_PAGE = 5;
        let activeInlineReplyButton = null; // è¿½è¸ªå“ªä¸ªæŒ‰é’®æ‰“å¼€äº†å†…è”å›å¤æ¡†

        // è·å–URLä¸­çš„è¯é¢˜IDå‚æ•°
        function getTopicId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // åŠ è½½è¯é¢˜è¯¦æƒ…
        function loadTopicDetail() {
            const topicId = getTopicId();
            if (!topicId) {
                window.location.href = 'home.html';
                return;
            }

            const topicDetailEl = document.getElementById('topicDetail');
            topicDetailEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¯é¢˜å†…å®¹...</div>';

            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('GET', `topics.php?id=${topicId}`, null,
                function(response) {
                    if (response.success && response.topic) {
                        const post = response.topic;

                        // æ„å»ºè¯¦æƒ…é¡µHTML
                        const tagsHtml = post.tags && post.tags.length > 0
                            ? `<div class="topic-tags">${post.tags.map(tag => `<span class="tag">${safeHtml(tag)}</span>`).join('')}</div>`
                            : '';

                        // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆä»…å¯¹ä½œè€…æˆ–ç®¡ç†å‘˜æ˜¾ç¤ºï¼‰
                        const currentUser = getCurrentUser();
                        const deleteButtonHtml = (currentUser && (currentUser === post.author || currentUser === 'admin'))
                            ? `<button id="deleteButton" class="action-button delete-button" onclick="deleteTopic('${topicId}')">
                                <span class="delete-icon">ğŸ—‘ï¸</span> åˆ é™¤è¯é¢˜
                              </button>`
                            : '';

                        // å¤„ç†è¯é¢˜å†…å®¹ï¼Œç¡®ä¿HTMLå®‰å…¨å¹¶æ­£ç¡®æ˜¾ç¤ºæ¢è¡Œ
                        const safeContent = safeHtml(post.content).replace(/\n/g, '<br>');

                        // æ„å»ºå›¾ç‰‡HTML
                        const imagesHtml = post.images && post.images.length > 0
                            ? `<div class="topic-images-container">
                                ${post.images.map(imgPath => `<img src="${safeHtml(imgPath)}" alt="è¯é¢˜å›¾ç‰‡" class="topic-image" onclick="openImageModal(this.src)">`).join('')}
                               </div>`
                            : '';

                        // æ·»åŠ ä½œè€…ä¿¡æ¯ã€æµè§ˆé‡ç­‰
                        const topicHtml = `
                            <div class="topic-header">
                                <h1 class="detail-title">${safeHtml(post.title)}</h1>
                                <span class="topic-category">${safeHtml(post.categoryName)}</span>
                            </div>
                            <div class="topic-meta">
                                <span class="topic-author">${safeHtml(post.author)}</span>
                                <span class="topic-time">${formatTime(post.timestamp)}</span>
                                <span class="topic-views">æµè§ˆ ${post.views}</span>
                            </div>
                            <div class="topic-full-content">${safeContent}</div>
                            ${imagesHtml}
                            ${tagsHtml}
                            <div class="topic-stats">
                                <button id="likeButton" class="action-button ${post.currentUserLiked ? 'liked' : ''}" onclick="likeTopic('${topicId}')">
                                    <span class="like-icon">â¤</span> ç‚¹èµ <span class="like-count-text">${post.likes || 0}</span>
                                </button>
                                <button class="action-button">
                                    <span class="comment-icon">ğŸ’¬</span> è¯„è®º <span class="commentCount">${post.comments || 0}</span>
                                </button>
                                ${deleteButtonHtml}
                            </div>
                        `;

                        topicDetailEl.innerHTML = topicHtml;

                        // æ›´æ–°é¡µé¢æ ‡é¢˜
                        document.title = `${post.title} - å‰å¤§æ ‘æ´`;

                        // åŠ è½½è¯„è®º
                        loadComments(topicId, currentSortBy);
                    } else {
                        topicDetailEl.innerHTML = '<div class="error-message">è¯é¢˜ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</div>';
                    }
                },
                function() {
                    topicDetailEl.innerHTML = '<div class="error-message">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥</div>';
                }
            );
        }

        // åˆ é™¤è¯é¢˜
        function deleteTopic(topicId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'delete_topic.php', { topicId: topicId },
                function(response) {
                    if (response.success) {
                        alert('è¯é¢˜åˆ é™¤æˆåŠŸï¼');
                        // è·³è½¬åˆ°é¦–é¡µ
                        window.location.href = 'home.html';
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + response.message);
                    }
                },
                function() {
                    alert('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
                }
            );
        }

        // ç‚¹èµåŠŸèƒ½
        function likeTopic(topicId) {
            const likeButton = document.getElementById('likeButton');
            
            const likeCountSpan = likeButton ? likeButton.querySelector('.like-count-text') : null; 
            
            if (!checkLoginRequired()) return;

            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'like_topic.php', { topicId: topicId },
                function(response) {
                    if (response.success) {
                        // æ›´æ–°æ˜¾ç¤ºçš„ç‚¹èµæ•°
                        if (likeCountSpan) { 
                            likeCountSpan.textContent = response.likes;
                        }
                        // æ›´æ–°æŒ‰é’®æ ·å¼
                        if (response.isLikedByCurrentUser) {
                            likeButton.classList.add('liked');
                        } else {
                            likeButton.classList.remove('liked');
                        }
                    } else {
                        console.error('ç‚¹èµ/å–æ¶ˆç‚¹èµå¤±è´¥:', response.message);
                        alert(response.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }
                },
                function() {
                    console.error('ç‚¹èµ/å–æ¶ˆç‚¹èµè¯·æ±‚å¤±è´¥');
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
                }
            );
        }

        // ç‚¹èµè¯„è®ºåŠŸèƒ½
        function likeComment(topicId, commentId, event) {
            if (!checkLoginRequired()) return;
            // å¦‚æœç‚¹èµæŒ‰é’®åœ¨å†…è”å›å¤æ¡†å†…è¢«ç‚¹å‡»ï¼Œé˜»æ­¢å†…è”å›å¤æ¡†å…³é—­
            if (event.target.closest('.inline-reply-box')) {
                 event.stopPropagation();
            }
            
            const likeButton = event.currentTarget;
            const likeCountSpan = likeButton.querySelector('.like-count-text');

            sendAjaxRequest('POST', 'like_comment.php', { topicId: topicId, commentId: commentId },
                function(response) {
                    if (response.success) {
                        if (likeCountSpan) {
                            likeCountSpan.textContent = response.likes;
                        }
                        if (response.isLikedByCurrentUser) {
                            likeButton.classList.add('liked');
                        } else {
                            likeButton.classList.remove('liked');
                        }
                    } else {
                        alert(response.message || 'ç‚¹èµ/å–æ¶ˆç‚¹èµå¤±è´¥');
                    }
                },
                function() {
                    alert('ç½‘ç»œé”™è¯¯ï¼Œç‚¹èµ/å–æ¶ˆç‚¹èµå¤±è´¥');
                }
            );
        }

        // åŠ è½½è¯é¢˜çš„è¯„è®º
        function loadComments(topicId, sortBy = 'floor_asc') {
            const commentListEl = document.getElementById('commentList');
            const commentCountEl = document.getElementById('commentCount');

            commentListEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>';

            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('GET', `comments.php?topicId=${topicId}&sortBy=${sortBy}`, null,
                function(response) {
                    if (response.success) {
                        const comments = response.comments || [];
                        currentTopicCommentsData = comments; // å­˜å‚¨ç”¨äºåˆ†é¡µ

                        // è®¡ç®—æ€»è¯„è®ºæ•°ï¼ˆåŒ…æ‹¬æ¥¼ä¸­æ¥¼å›å¤ï¼‰
                        let totalComments = 0;
                        comments.forEach(comment => {
                            totalComments++; // ä¸»è¯„è®ºè®¡1
                            if (comment.replies && comment.replies.length > 0) {
                                totalComments += comment.replies.length; // æ¥¼ä¸­æ¥¼å›å¤ä¹Ÿè®¡å…¥
                            }
                        });

                        // æ›´æ–°è¯„è®ºæ•°é‡
                        commentCountEl.textContent = totalComments;

                        // å¦‚æœæ²¡æœ‰è¯„è®º
                        if (comments.length === 0) {
                            commentListEl.innerHTML = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
                            return;
                        }

                        // æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
                        commentListEl.innerHTML = '';
                        comments.forEach((comment) => {
                            const commentEl = createCommentElement(comment, topicId);
                            commentListEl.appendChild(commentEl);
                        });
                    } else {
                        commentListEl.innerHTML = '<div class="error-message">åŠ è½½è¯„è®ºå¤±è´¥</div>';
                    }
                },
                function() {
                    commentListEl.innerHTML = '<div class="error-message">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥</div>';
                }
            );
        }

        // åˆ›å»ºè¯„è®ºå…ƒç´ 
        function createCommentElement(comment, topicId) {
            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item';
            commentEl.setAttribute('data-comment-id', comment.id); // æ·»åŠ data-idç”¨äºå®šä½

            const safeContent = safeHtml(comment.content).replace(/\n/g, '<br>');
            const commentImagesHtml = comment.images && comment.images.length > 0
                ? `<div class="comment-images-container">
                    ${comment.images.map(imgPath => `<img src="${safeHtml(imgPath)}" alt="è¯„è®ºå›¾ç‰‡" class="comment-image" onclick="openImageModal(this.src)">`).join('')}
                   </div>`
                : '';
            const commentLikeButtonClass = comment.currentUserLiked ? 'comment-like liked' : 'comment-like';

            // ä¸»è¯„è®ºç»“æ„
            commentEl.innerHTML = `
                <div class="comment-main">
                    <div class="comment-body">
                        <div class="comment-header">
                            <div class="comment-author-details">
                                <span class="comment-author">${safeHtml(comment.author)}</span>
                                <div class="comment-floor-number">${comment.floor}æ¥¼</div>
                            </div>
                            <span class="comment-time">${formatTime(comment.timestamp)}</span>
                        </div>
                        <div class="comment-content">${safeContent}</div>
                        ${commentImagesHtml}
                        <div class="comment-footer">
                            <button class="${commentLikeButtonClass}" onclick="likeComment('${topicId}', '${comment.id}', event)">
                                <span class="like-icon">ğŸ‘</span> <span class="like-count-text">${comment.likes || 0}</span>
                            </button>
                            <button class="comment-reply-btn" onclick="openInlineReplyBox('${comment.id}', '${comment.floor}', '${safeHtml(comment.author)}', this, '${comment.id}', '${comment.author_user_id}')">
                                <span class="reply-icon">ğŸ’¬</span> å›å¤
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // å¤„ç†æ¥¼ä¸­æ¥¼å›å¤
            if (comment.replies && comment.replies.length > 0) {
                const allReplies = comment.replies;
                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'comment-replies-container';
                
                const repliesHeader = document.createElement('div');
                repliesHeader.className = 'replies-header';
                repliesHeader.innerHTML = `
                    <span class="replies-count">${allReplies.length} æ¡å›å¤</span>
                    <button class="toggle-replies-btn" onclick="toggleReplies(this, '${comment.id}', '${topicId}')">
                        <span class="toggle-text">å±•å¼€</span>
                        <span class="toggle-icon">â–¼</span>
                    </button>
                `;
                
                const repliesContent = document.createElement('div');
                repliesContent.className = 'replies-content';
                repliesContent.id = `replies-content-${comment.id}`;
                repliesContent.style.display = 'none'; // åˆå§‹éšè—
                
                const repliesPagination = document.createElement('div');
                repliesPagination.className = 'replies-pagination';
                repliesPagination.id = `replies-pagination-${comment.id}`;
                repliesPagination.style.display = 'none'; // åˆå§‹éšè—

                repliesContainer.appendChild(repliesHeader);
                repliesContainer.appendChild(repliesContent);
                repliesContainer.appendChild(repliesPagination);
                commentEl.appendChild(repliesContainer);
            }

            return commentEl;
        }

        // æ˜¾ç¤ºæ¥¼ä¸­æ¥¼å›å¤çš„ç‰¹å®šé¡µé¢
        function displayRepliesPage(commentId, topicId, page) {
            // Ensure commentId is treated as a number for comparison if c.id is a number
            const mainCommentData = currentTopicCommentsData.find(c => c.id === parseInt(commentId)); 
            if (!mainCommentData || !mainCommentData.replies) return;

            const allReplies = mainCommentData.replies;
            const repliesContentEl = document.getElementById(`replies-content-${commentId}`);
            const paginationControlsEl = document.getElementById(`replies-pagination-${commentId}`);

            if (!repliesContentEl || !paginationControlsEl) return;

            repliesContentEl.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€é¡µ
            paginationControlsEl.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€é¡µçš„æ§ä»¶

            const totalReplies = allReplies.length;
            const totalPages = Math.ceil(totalReplies / REPLIES_PER_PAGE);
            
            const startIndex = (page - 1) * REPLIES_PER_PAGE;
            const endIndex = Math.min(startIndex + REPLIES_PER_PAGE, totalReplies);
            const currentPageReplies = allReplies.slice(startIndex, endIndex);

            currentPageReplies.forEach(reply => {
                const replyEl = document.createElement('div');
                replyEl.className = 'reply-item';
                
                const replyContent = safeHtml(reply.content).replace(/\n/g, '<br>');
                const replyImagesHtml = reply.images && reply.images.length > 0
                    ? `<div class="comment-images-container">
                        ${reply.images.map(imgPath => `<img src="${safeHtml(imgPath)}" alt="å›å¤å›¾ç‰‡" class="comment-image" onclick="openImageModal(this.src)">`).join('')}
                       </div>`
                    : '';
                const replyLikeButtonClass = reply.currentUserLiked ? 'comment-like liked' : 'comment-like';

                let displayContent = replyContent;
                if (reply.replyToFloor && reply.replyToAuthor) {
                    displayContent = `<span class="reply-target">å›å¤ ${reply.replyToFloor}æ¥¼ @${safeHtml(reply.replyToAuthor)}:</span> ${replyContent}`;
                }

                replyEl.innerHTML = `
                    <div class="reply-header">
                        <span class="reply-author">${safeHtml(reply.author)}</span>
                        <span class="reply-time">${formatTime(reply.timestamp)}</span>
                    </div>
                    <div class="reply-content">${displayContent}</div>
                    ${replyImagesHtml}
                    <div class="reply-footer">
                        <button class="${replyLikeButtonClass}" onclick="likeComment('${topicId}', '${reply.id}', event)">
                            <span class="like-icon">ğŸ‘</span> <span class="like-count-text">${reply.likes || 0}</span>
                        </button>
                        <button class="comment-reply-btn" onclick="openInlineReplyBox('${commentId}', '${mainCommentData.floor}', '${safeHtml(reply.author)}', this, '${reply.id}', '${reply.author_user_id}')">
                            <span class="reply-icon">ğŸ’¬</span> å›å¤
                        </button>
                    </div>
                `;
                repliesContentEl.appendChild(replyEl);
            });

            // æ¸²æŸ“åˆ†é¡µæ§ä»¶
            if (totalPages > 1) {
                if (page > 1) {
                    const prevButton = document.createElement('button');
                    prevButton.textContent = 'ä¸Šä¸€é¡µ';
                    prevButton.onclick = () => displayRepliesPage(commentId, topicId, page - 1);
                    paginationControlsEl.appendChild(prevButton);
                }

                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    if (i === page) {
                        pageButton.disabled = true;
                        pageButton.classList.add('active');
                    }
                    pageButton.onclick = () => displayRepliesPage(commentId, topicId, i);
                    paginationControlsEl.appendChild(pageButton);
                }

                if (page < totalPages) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                    nextButton.onclick = () => displayRepliesPage(commentId, topicId, page + 1);
                    paginationControlsEl.appendChild(nextButton);
                }
            }
        }

        // æ‰“å¼€å›å¤è¯é¢˜çš„æ¨¡æ€æ¡†
        function openReplyModalForTopic() {
            const modal = document.getElementById('replyModal');
            const title = document.getElementById('replyModalTitle');
            const content = document.getElementById('reply_content');
            const parentIdInput = document.getElementById('parentCommentId');
            const replyFloorInput = document.getElementById('replyToFloor');
            const replyAuthorInput = document.getElementById('replyToAuthor');
            const uploadSection = document.getElementById('modalUploadSection');

            resetReplyForm(); // é‡ç½®ä¸»æ¨¡æ€æ¡†è¡¨å•

            title.textContent = 'å›å¤è¯é¢˜';
            content.placeholder = 'è¯·è¾“å…¥æ‚¨çš„è¯„è®ºå†…å®¹...';
            parentIdInput.value = ''; // å›å¤è¯é¢˜ï¼Œæ— çˆ¶è¯„è®º
            replyFloorInput.value = '0';
            replyAuthorInput.value = '';
            uploadSection.style.display = 'block'; // å›å¤è¯é¢˜æ—¶æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ 

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            content.focus();
        }
        
        // å…³é—­å›å¤è¯é¢˜çš„æ¨¡æ€æ¡†
        function closeReplyModal() {
            const modal = document.getElementById('replyModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetReplyForm();
        }

        // é‡ç½®å›å¤è¯é¢˜çš„æ¨¡æ€æ¡†è¡¨å•
        function resetReplyForm() {
            document.getElementById('reply_content').value = '';
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('file-count').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            document.getElementById('images').value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('anonymous').checked = false;
            const messageEl = document.getElementById('message');
            messageEl.style.display = 'none';
            messageEl.className = 'message-box';
        }

        // æ‰“å¼€å†…è”å›å¤æ¡† (ç”¨äºå›å¤è¯„è®º/æ¥¼ä¸­æ¥¼)
        function openInlineReplyBox(parentCommentId, floor, author, buttonElement, replyTargetCommentId, replyTargetUserId) {
            if (!checkLoginRequired()) return;

            closeInlineReplyBox(); // å…ˆå…³é—­ä»»ä½•å·²å­˜åœ¨çš„å†…è”æ¡†

            activeInlineReplyButton = buttonElement;
            const inlineReplyBox = document.getElementById('inlineReplyBox');
            document.getElementById('inlineParentCommentId').value = parentCommentId; // è¿™æ˜¯ä¸»è¯„è®ºçš„ID
            document.getElementById('inlineReplyToFloor').value = floor; // è¿™æ˜¯è¢«å›å¤ç›®æ ‡çš„æ¥¼å±‚ (å¯èƒ½æ˜¯ä¸»è¯„è®ºçš„æ¥¼å±‚)
            document.getElementById('inlineReplyToAuthor').value = author; // è¿™æ˜¯è¢«å›å¤ç›®æ ‡çš„ä½œè€…æ˜µç§°
            document.getElementById('inlineReplyTargetCommentId').value = replyTargetCommentId; // è¿™æ˜¯è¢«ç›´æ¥å›å¤çš„è¯„è®º/å›å¤çš„ID
            document.getElementById('inlineReplyToAuthorId').value = replyTargetUserId; // è¿™æ˜¯è¢«ç›´æ¥å›å¤çš„è¯„è®º/å›å¤çš„ä½œè€…çš„User ID
            
            const inlineContent = document.getElementById('inlineReplyContent');
            // æ›´æ–°placeholderä»¥åæ˜ å›å¤çš„æ˜¯è°
            const targetAuthorDisplay = author || 'è¯¥ç”¨æˆ·';
            const targetFloorDisplay = floor ? `${floor}æ¥¼ ` : '';
            inlineContent.placeholder = `å›å¤ ${targetFloorDisplay}@${targetAuthorDisplay}...`;
            inlineContent.value = ''; // æ¸…ç©ºå…ˆå‰å†…å®¹

            // å®šä½å†…è”å›å¤æ¡†
            const commentItem = buttonElement.closest('.comment-item, .reply-item'); // æ‰¾åˆ°çˆ¶è¯„è®ºæˆ–å›å¤é¡¹
            
            if (commentItem) {
                 // è¿½åŠ åˆ°è¯„è®º/å›å¤é¡¹çš„é¡µè„šåï¼Œä»¥è·å¾—æ›´å¥½çš„æµç¨‹
                const footer = buttonElement.closest('.comment-footer, .reply-footer');
                if (footer) {
                    footer.parentNode.insertBefore(inlineReplyBox, footer.nextSibling);
                } else { // å¦‚æœæœªæ‰¾åˆ°é¡µè„šï¼Œåˆ™è¿½åŠ åˆ°è¯„è®ºé¡¹
                    commentItem.appendChild(inlineReplyBox);
                }
            } else { // å›é€€ï¼šå¦‚æœæœªæ‰¾åˆ°è¯„è®ºé¡¹ï¼Œåˆ™å®šä½åœ¨æŒ‰é’®é™„è¿‘ (ä¸åº”å‘ç”Ÿ)
                const rect = buttonElement.getBoundingClientRect();
                inlineReplyBox.style.top = (window.scrollY + rect.bottom + 5) + 'px';
                inlineReplyBox.style.left = (window.scrollX + rect.left) + 'px';
                document.body.appendChild(inlineReplyBox); // å¦‚æœæ²¡æœ‰æ›´å¥½çš„ä½ç½®ï¼Œåˆ™è¿½åŠ åˆ°body
            }
            
            inlineReplyBox.style.display = 'block';
            inlineContent.focus();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»å¤–éƒ¨æ—¶å…³é—­
            // ä½¿ç”¨setTimeouté¿å…å› æ‰“å¼€å®ƒçš„ç‚¹å‡»è€Œç«‹å³å…³é—­
            setTimeout(() => {
                document.addEventListener('click', handleClickOutsideInlineReplyBox, true);
            }, 0);
        }

        function handleClickOutsideInlineReplyBox(event) {
            const inlineReplyBox = document.getElementById('inlineReplyBox');
            if (inlineReplyBox.style.display === 'block' && !inlineReplyBox.contains(event.target) && activeInlineReplyButton && !activeInlineReplyButton.contains(event.target)) {
                // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯ä»»ä½•â€œå›å¤â€æŒ‰é’®ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å…³é—­ï¼Œå› ä¸ºå¦ä¸€ä¸ªä¼šæ‰“å¼€ã€‚
                if (!event.target.classList.contains('comment-reply-btn')) {
                    closeInlineReplyBox();
                }
            }
        }

        // å…³é—­å†…è”å›å¤æ¡†
        function closeInlineReplyBox() {
            const inlineReplyBox = document.getElementById('inlineReplyBox');
            if (inlineReplyBox) {
                inlineReplyBox.style.display = 'none';
                document.getElementById('inlineReplyContent').value = '';
                const messageEl = document.getElementById('inlineReplyMessage');
                messageEl.style.display = 'none';
                messageEl.className = 'message-box';

                // ç¡®ä¿å®ƒè¢«è¿½åŠ åˆ°bodyå¹¶éšè—ï¼Œä¸ºä¸‹æ¬¡ä½¿ç”¨åšå‡†å¤‡
                // è¿™å¯ä»¥é˜²æ­¢åœ¨é‡å»ºè¯„è®ºåˆ—è¡¨æ—¶å®ƒå˜æˆå­¤ç«‹çš„
                if (inlineReplyBox.parentNode !== document.body) {
                    document.body.appendChild(inlineReplyBox);
                }

                document.removeEventListener('click', handleClickOutsideInlineReplyBox, true);
                activeInlineReplyButton = null;
            }
        }

        // æäº¤å†…è”å›å¤
        function submitInlineReply() {
            if (!isLoggedIn()) {
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º');
                window.location.href = 'login.html';
                return;
            }

            const topicId = getTopicId();
            const content = document.getElementById('inlineReplyContent').value.trim();
            const parentCommentId = document.getElementById('inlineParentCommentId').value;
            const replyToFloor = document.getElementById('inlineReplyToFloor').value;
            const replyToAuthor = document.getElementById('inlineReplyToAuthor').value;
            const messageEl = document.getElementById('inlineReplyMessage');

            if (!content) {
                showMessageElement(messageEl, 'å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            showMessageElement(messageEl, '', 'none'); // æ¸…é™¤å…ˆå‰çš„æ¶ˆæ¯

            const replyTargetCommentId = document.getElementById('inlineReplyTargetCommentId').value; // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„IDè·å–ç›®æ ‡è¯„è®ºID
            const replyTargetUserId = document.getElementById('inlineReplyToAuthorId').value; 

            const formData = new FormData();
            formData.append('topicId', topicId);
            formData.append('content', content);
            formData.append('parentCommentId', parentCommentId); // ä¸»è¯„è®ºID
            formData.append('replyTargetCommentId', replyTargetCommentId); // ç›®æ ‡è¯„è®ºID
            formData.append('replyTargetUserId', replyTargetUserId); // ç›®æ ‡ç”¨æˆ·ID
            formData.append('anonymous', '0');

            sendAjaxRequest('POST', 'comments.php', formData,
                function(response) {
                    if (response.success) {
                        showMessageElement(messageEl, 'å›å¤æˆåŠŸï¼', 'success');
                        setTimeout(() => {
                            closeInlineReplyBox();
                            loadComments(topicId, currentSortBy);
                        }, 1000);
                    } else {
                        showMessageElement(messageEl, response.message || 'å›å¤å¤±è´¥ï¼', 'error');
                    }
                },
                function() {
                    showMessageElement(messageEl, 'ç½‘ç»œé”™è¯¯ï¼', 'error');
                }
            );
        }
        
        // ç”¨äºåœ¨ç‰¹å®šå…ƒç´ ä¸­æ˜¾ç¤ºæ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°
        function showMessageElement(element, message, type) {
            if (!element) return;
            element.innerHTML = message;
            if (type === 'none') {
                element.style.display = 'none';
            } else {
                element.className = `message-box ${type}`;
                element.style.display = 'block';
            }
        }


        // æäº¤å›å¤ (æ­¤å‡½æ•°ç°åœ¨ä»…ç”¨äºå›å¤è¯é¢˜çš„ä¸»æ¨¡æ€æ¡†)
        function submitReply() {
            if (!isLoggedIn()) {
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º');
                window.location.href = 'login.html';
                return;
            }

            const topicId = getTopicId();
            const content = document.getElementById('reply_content').value.trim();
            const anonymous = document.getElementById('anonymous').checked;
            const imagesInput = document.getElementById('images');
            const parentCommentId = document.getElementById('parentCommentId').value; // å›å¤è¯é¢˜æ—¶åº”ä¸ºç©º
            const replyToFloor = document.getElementById('replyToFloor').value; // å›å¤è¯é¢˜æ—¶åº”ä¸º0
            const replyToAuthor = document.getElementById('replyToAuthor').value; // å›å¤è¯é¢˜æ—¶åº”ä¸ºç©º

            if (!content) {
                alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }

            const messageEl = document.getElementById('message');
            messageEl.style.display = 'none';

            const formData = new FormData();
            formData.append('topicId', topicId);
            formData.append('content', content);
            formData.append('anonymous', anonymous ? '1' : '0');
            formData.append('parentCommentId', parentCommentId);
            formData.append('replyToFloor', replyToFloor);
            formData.append('replyToAuthor', replyToAuthor);

            if (imagesInput.files.length > 0) {
                for (let i = 0; i < imagesInput.files.length; i++) {
                    formData.append('images[]', imagesInput.files[i]);
                }
            }

            sendAjaxRequest('POST', 'comments.php', formData,
                function(response) {
                    if (response.success) {
                        messageEl.innerHTML = 'è¯„è®ºå‘è¡¨æˆåŠŸï¼';
                        messageEl.className = 'message-box success';
                        messageEl.style.display = 'block';

                        setTimeout(() => {
                            closeReplyModal();
                            loadComments(topicId, currentSortBy); // é‡æ–°åŠ è½½è¯é¢˜è¯„è®º
                        }, 1000);
                    } else {
                        messageEl.innerHTML = response.message || 'è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼';
                        messageEl.className = 'message-box error';
                        messageEl.style.display = 'block';
                    }
                },
                function() {
                    messageEl.innerHTML = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥ï¼';
                    messageEl.className = 'message-box error';
                    messageEl.style.display = 'block';
                }
            );
        }

        // åˆ‡æ¢å›å¤æ˜¾ç¤º/éšè—
        function toggleReplies(button, commentId, topicId) {
            const repliesContainer = button.closest('.comment-replies-container');
            const repliesContent = repliesContainer.querySelector(`#replies-content-${commentId}`);
            const repliesPagination = repliesContainer.querySelector(`#replies-pagination-${commentId}`);
            const toggleText = button.querySelector('.toggle-text');
            const toggleIcon = button.querySelector('.toggle-icon');

            const isHidden = repliesContent.style.display === 'none';

            if (isHidden) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å±•å¼€æˆ–å†…å®¹ä¸ºç©ºï¼ˆä¾‹å¦‚æ’åºåï¼‰ï¼Œåˆ™æ¸²æŸ“ç¬¬ä¸€é¡µ
                if (repliesContent.innerHTML.trim() === '') {
                     displayRepliesPage(commentId, topicId, 1);
                }
                repliesContent.style.display = 'block';
                repliesPagination.style.display = 'flex'; // åˆ†é¡µæŒ‰é’®ä½¿ç”¨flexå¸ƒå±€
                toggleText.textContent = 'æ”¶èµ·';
                toggleIcon.textContent = 'â–²';
            } else {
                repliesContent.style.display = 'none';
                repliesPagination.style.display = 'none';
                toggleText.textContent = 'å±•å¼€';
                toggleIcon.textContent = 'â–¼';
            }
        }

        // æ¨¡æ€æ¡†æ‹–æ‹½åŠŸèƒ½
        function initModalDrag() {
            const modal = document.getElementById('replyModalContent');
            const header = modal.querySelector('.reply-modal-header');

            header.addEventListener('mousedown', function(e) {
                isReplyModalDragging = true;
                const rect = modal.getBoundingClientRect();
                replyModalOffset.x = e.clientX - rect.left;
                replyModalOffset.y = e.clientY - rect.top;
                header.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', function(e) {
                if (isReplyModalDragging) {
                    const x = e.clientX - replyModalOffset.x;
                    const y = e.clientY - replyModalOffset.y;
                    modal.style.left = Math.max(0, Math.min(x, window.innerWidth - modal.offsetWidth)) + 'px';
                    modal.style.top = Math.max(0, Math.min(y, window.innerHeight - modal.offsetHeight)) + 'px';
                }
            });

            document.addEventListener('mouseup', function() {
                if (isReplyModalDragging) {
                    isReplyModalDragging = false;
                    header.style.cursor = 'grab';
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æµ®åŠ¨å›å¤æŒ‰é’®ç°åœ¨åº”è°ƒç”¨ openReplyModalForTopic
            const mainFloatingReplyBtn = document.getElementById('floatingReplyBtnMainTopic');
            if (mainFloatingReplyBtn) {
                 mainFloatingReplyBtn.setAttribute('onclick', 'openReplyModalForTopic()');
            }

            updateNavUserStatus();
            loadTopicDetail();
            initModalDrag();

            // è®¾ç½®è¯„è®ºæ’åºç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.comment-sort-options a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // ç§»é™¤ä¹‹å‰çš„activeç±»
                    document.querySelectorAll('.comment-sort-options a').forEach(item => {
                        item.classList.remove('active');
                    });

                    // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»é¡¹
                    this.classList.add('active');

                    // æ›´æ–°æ’åºæ–¹å¼å¹¶é‡æ–°åŠ è½½è¯„è®º
                    currentSortBy = this.getAttribute('data-sort');
                    const topicId = getTopicId();
                    if (topicId) {
                        loadComments(topicId, currentSortBy);
                    }
                });
            });

            // å¤„ç†å›¾ç‰‡é¢„è§ˆ
            document.getElementById('images').addEventListener('change', function(e) {
                const fileCount = e.target.files.length;
                document.getElementById('file-count').textContent =
                    fileCount > 0 ? `å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©æ–‡ä»¶';

                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';

                for(let i = 0; i < Math.min(fileCount, 3); i++) {
                    const file = e.target.files[i];
                    if(file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.width = '80px';
                            img.style.height = '80px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '4px';
                            previewContainer.appendChild(img);
                        }
                        reader.readAsDataURL(file);
                    }
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ (é’ˆå¯¹ä¸»å›å¤æ¨¡æ€æ¡†)
            document.getElementById('replyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReplyModal();
                }
            });

            // ç¡®ä¿å†…è”å›å¤æ¡†åˆå§‹éšè—å¹¶ä»DOMä¸­åˆ†ç¦»ï¼ˆå¦‚æœæ˜¯å…±äº«å…ƒç´ ï¼‰
            const inlineReplyBox = document.getElementById('inlineReplyBox');
            if (inlineReplyBox && inlineReplyBox.parentNode) {
                inlineReplyBox.parentNode.removeChild(inlineReplyBox);
            }
            document.body.appendChild(inlineReplyBox); // ä¿ç•™åœ¨bodyä¸­ï¼Œæ›´å®¹æ˜“ç®¡ç† display:none
            inlineReplyBox.style.display = 'none';
        });

        // æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImageSrc');
            if (modal && modalImg) {
                modal.style.display = "flex"; // ä½¿ç”¨ flex ä»¥ä¾¿ CSS ä¸­çš„ align-items å’Œ justify-content ç”Ÿæ•ˆ
                modalImg.src = src;
                document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            }
        }

        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = "none";
                document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            }
        }
    </script>

    <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal-btn" onclick="closeImageModal()">&times;</span>
        <img class="modal-content-image" id="modalImageSrc">
    </div>
</body>
</html>
